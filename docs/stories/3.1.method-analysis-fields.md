# Story 3.1: Add Method Analysis Fields to Trade Log

## Status
Draft

## Story
**As a** trader,  
**I want** to log the specific indicators, signals, and any key divergences I used for a trade,  
**so that** I can analyze the effectiveness of my trading method over time.

## Acceptance Criteria

1. The "Method Analysis" section now includes a dedicated field to specify "Bullish Divergence," "Bearish Divergence," or "None"
2. The section still contains dropdowns for other indicators/signals and a notes field for each of the three timeframes
3. The selected and entered analysis is saved with the trade record

## Tasks / Subtasks

- [ ] Task 1: Create MethodAnalysis data model and schema (AC: 3)
  - [ ] Define MethodAnalysis TypeScript interface in packages/shared
  - [ ] Add MethodAnalysis model to Prisma schema with Trade relationship
  - [ ] Create enum types for indicators, signals, and divergences
  - [ ] Generate Prisma client and run migration
  - [ ] Add database indexes for efficient filtering

- [ ] Task 2: Implement backend API for method analysis (AC: 3)
  - [ ] Enhance POST /api/trades to include method analysis
  - [ ] Create PATCH /api/trades/{id}/analysis endpoint for updates
  - [ ] Add comprehensive validation for analysis fields
  - [ ] Implement method analysis retrieval in trade queries
  - [ ] Add bulk analysis operations for efficiency

- [ ] Task 3: Create method analysis form components (AC: 1, 2)
  - [ ] Build MethodAnalysisForm component for three timeframes
  - [ ] Add divergence selection with clear labeling
  - [ ] Implement indicator/signal dropdown menus
  - [ ] Add notes field for each timeframe
  - [ ] Create reusable timeframe analysis component

- [ ] Task 4: Integrate method analysis into trade workflow (AC: 1, 2, 3)
  - [ ] Add method analysis section to TradeForm
  - [ ] Update TradeList to display method indicators
  - [ ] Add method analysis to trade detail views
  - [ ] Implement progressive disclosure for complex analysis
  - [ ] Ensure mobile-friendly analysis input

- [ ] Task 5: Create method analysis display components (AC: 3)
  - [ ] Build MethodAnalysisDisplay for read-only viewing
  - [ ] Add indicator/signal badge components
  - [ ] Create divergence indicator with visual clarity
  - [ ] Show timeframe breakdown clearly
  - [ ] Add editing capabilities for existing trades

- [ ] Task 6: Write comprehensive tests (AC: 1, 2, 3)
  - [ ] Backend unit tests for method analysis validation
  - [ ] Backend integration tests for analysis API endpoints
  - [ ] Frontend component tests for MethodAnalysisForm
  - [ ] E2E test for complete method analysis workflow
  - [ ] Test analysis filtering and search functionality

## Dev Notes

### Previous Story Context
Story 2.4 established market data integration. This story adds the "Method" component of the Three M's framework, enabling traders to track their technical analysis methodology.

### Data Models
[Source: docs/architecture.md#data-models]

**MethodAnalysis Model:**
```typescript
interface MethodAnalysis {
  id: string;
  tradeId: string;
  timeframe: 'DAILY' | 'FOUR_HOUR' | 'ONE_HOUR';
  indicator: IndicatorType;
  signal: SignalType;
  divergence: 'BULLISH' | 'BEARISH' | 'NONE';
  notes: string | null;
  createdAt: Date;
  updatedAt: Date;
}

enum IndicatorType {
  MACD = 'MACD',
  RSI = 'RSI',
  STOCHASTICS = 'STOCHASTICS',
  MOVING_AVERAGES = 'MOVING_AVERAGES',
  BOLLINGER_BANDS = 'BOLLINGER_BANDS',
  VOLUME = 'VOLUME',
  SUPPORT_RESISTANCE = 'SUPPORT_RESISTANCE',
  TRENDLINES = 'TRENDLINES',
  FIBONACCI = 'FIBONACCI',
  OTHER = 'OTHER'
}

enum SignalType {
  BUY_SIGNAL = 'BUY_SIGNAL',
  SELL_SIGNAL = 'SELL_SIGNAL',
  CONTINUATION = 'CONTINUATION',
  REVERSAL = 'REVERSAL',
  BREAKOUT = 'BREAKOUT',
  BREAKDOWN = 'BREAKDOWN',
  OVERSOLD = 'OVERSOLD',
  OVERBOUGHT = 'OVERBOUGHT',
  NEUTRAL = 'NEUTRAL'
}
```

**Prisma Schema Addition:**
```prisma
model MethodAnalysis {
  id        String        @id @default(cuid())
  tradeId   String
  timeframe TimeframeType
  indicator IndicatorType
  signal    SignalType
  divergence DivergenceType @default(NONE)
  notes     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  trade Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  
  @@unique([tradeId, timeframe])
}

enum TimeframeType {
  DAILY
  FOUR_HOUR
  ONE_HOUR
}

enum DivergenceType {
  BULLISH
  BEARISH
  NONE
}
```

### API Specifications
[Source: docs/architecture.md#api-specification]

**Enhanced POST /api/trades**
- Request body includes methodAnalysis array
- Validates analysis for each timeframe
- Creates trade and related analysis atomically
- Returns trade with complete method analysis

**PATCH /api/trades/{tradeId}/analysis**
- Updates method analysis for existing trade
- Request body: array of MethodAnalysis updates
- Validates timeframe uniqueness
- Returns updated analysis with trade context

### Form Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**MethodAnalysisForm Component:**
```typescript
interface MethodAnalysisFormProps {
  initialAnalysis?: MethodAnalysis[];
  onAnalysisChange: (analysis: MethodAnalysis[]) => void;
  disabled?: boolean;
}

// Key features:
// - Three timeframe sections (Daily, 4H, 1H)
// - Indicator dropdown with search functionality
// - Signal dropdown with contextual options
// - Divergence radio buttons with clear labels
// - Notes textarea for additional context
// - Validation for required fields
```

**TimeframeAnalysis Component:**
```typescript
interface TimeframeAnalysisProps {
  timeframe: TimeframeType;
  analysis: Partial<MethodAnalysis>;
  onChange: (analysis: Partial<MethodAnalysis>) => void;
  disabled?: boolean;
}

// Visual layout:
// - Clear timeframe header
// - Horizontal layout for indicator/signal dropdowns
// - Prominent divergence selection
// - Expandable notes section
// - Mobile-responsive stacking
```

### Integration with Existing Components
[Source: docs/architecture.md#frontend-architecture]

**TradeForm Enhancement:**
- Add MethodAnalysisForm section after basic trade details
- Use progressive disclosure to avoid overwhelming new users
- Validate that at least one timeframe has analysis
- Save analysis alongside trade creation

**TradeList Enhancement:**
- Show key indicators as badges/chips
- Display divergence status with visual indicators
- Add method-based filtering capabilities
- Include analysis summary in trade tooltips

### Method Analysis Display
[Source: docs/architecture.md#ui-ux-specification]

**Visual Design Principles:**
- Clear hierarchy: timeframe → indicator → signal → divergence
- Consistent iconography for different indicators
- Color coding for divergence types (green/red/gray)
- Compact display for list views
- Detailed display for individual trade views

### File Locations
- Method analysis types: `packages/shared/src/types/analysis.ts`
- Method analysis API: `apps/api/src/routes/trades.ts` (enhancement)
- MethodAnalysisForm: `apps/web/src/components/MethodAnalysisForm.tsx`
- TimeframeAnalysis: `apps/web/src/components/TimeframeAnalysis.tsx`
- Analysis display: `apps/web/src/components/MethodAnalysisDisplay.tsx`
- Updated TradeForm: `apps/web/src/components/TradeForm.tsx`

### Validation Rules
[Source: docs/architecture.md#critical-implementation-requirements]

**Method Analysis Validation:**
```typescript
const validateMethodAnalysis = (analysis: MethodAnalysis[]): ValidationResult => {
  // Ensure one analysis per timeframe
  const timeframes = analysis.map(a => a.timeframe);
  if (new Set(timeframes).size !== timeframes.length) {
    return { isValid: false, error: 'Duplicate timeframe analysis' };
  }
  
  // Validate required fields
  for (const item of analysis) {
    if (!item.indicator || !item.signal) {
      return { 
        isValid: false, 
        error: `Missing indicator or signal for ${item.timeframe}` 
      };
    }
  }
  
  return { isValid: true };
};
```

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- Method analysis form validation and submission
- Timeframe uniqueness enforcement
- Indicator/signal dropdown functionality
- Divergence selection and validation
- Analysis display across different views
- Integration with trade creation workflow

**Form Validation Test Cases:**
```typescript
// Test complete method analysis
{
  methodAnalysis: [
    {
      timeframe: 'DAILY',
      indicator: 'MACD',
      signal: 'BUY_SIGNAL',
      divergence: 'BULLISH',
      notes: 'Strong momentum divergence'
    },
    {
      timeframe: 'FOUR_HOUR',
      indicator: 'RSI',
      signal: 'OVERSOLD',
      divergence: 'NONE',
      notes: 'RSI showing oversold conditions'
    }
  ],
  shouldValidate: true,
  shouldSave: true
}
```

#### Testing Standards
- Test all indicator/signal combinations
- Verify divergence logic and display
- Test form state management across timeframes
- Mock API responses for analysis operations
- E2E test covers complete analysis workflow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_