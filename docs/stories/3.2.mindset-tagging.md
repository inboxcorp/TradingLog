# Story 3.2: Add Mindset Tagging to Trade Log

## Status
Draft

## Story
**As a** trader,  
**I want** to tag my psychological state when I enter a trade,  
**so that** I can analyze how my emotions affect my performance.

## Acceptance Criteria

1. The "New Trade" form is extended to include a "Mindset" section
2. This section allows the user to select one or more pre-defined tags from a list (e.g., "Disciplined," "Anxious," "FOMO," "Patient")
3. The selected tags are saved with the trade record

## Tasks / Subtasks

- [ ] Task 1: Create MindsetTag data model and schema (AC: 3)
  - [ ] Define MindsetTag TypeScript interface in packages/shared
  - [ ] Add MindsetTag model to Prisma schema with Trade relationship
  - [ ] Create predefined mindset tag enum with psychological states
  - [ ] Generate Prisma client and run migration
  - [ ] Add junction table for many-to-many relationship

- [ ] Task 2: Implement backend API for mindset tagging (AC: 3)
  - [ ] Enhance POST /api/trades to include mindset tags
  - [ ] Create PATCH /api/trades/{id}/mindset endpoint for updates
  - [ ] Add validation for mindset tag selection
  - [ ] Implement tag retrieval in trade queries
  - [ ] Add mindset-based filtering capabilities

- [ ] Task 3: Create mindset tag selection component (AC: 1, 2)
  - [ ] Build MindsetTagSelector with multi-select functionality
  - [ ] Add visual tag representation with colors/icons
  - [ ] Implement search and filter for tag selection
  - [ ] Add tag combination validation and suggestions
  - [ ] Create custom tag creation capability (future enhancement)

- [ ] Task 4: Integrate mindset section into trade form (AC: 1, 2)
  - [ ] Add MindsetTagSelector to TradeForm component
  - [ ] Position mindset section appropriately in form flow
  - [ ] Add validation for mindset tag requirements
  - [ ] Implement form state management for tags
  - [ ] Add helpful guidance text for psychological awareness

- [ ] Task 5: Create mindset display and analysis features (AC: 3)
  - [ ] Build MindsetTagDisplay for trade lists and details
  - [ ] Add mindset-based filtering to trade journal
  - [ ] Create mindset frequency analysis component
  - [ ] Implement mindset performance correlation display
  - [ ] Add mindset trend analysis over time

- [ ] Task 6: Write comprehensive tests (AC: 1, 2, 3)
  - [ ] Backend unit tests for mindset tag relationships
  - [ ] Backend integration tests for mindset API endpoints
  - [ ] Frontend component tests for MindsetTagSelector
  - [ ] E2E test for complete mindset tagging workflow
  - [ ] Test mindset-based filtering and analysis

## Dev Notes

### Previous Story Context
Story 3.1 established method analysis tracking. This story adds the "Mind" component of the Three M's framework, enabling psychological state tracking and analysis.

### Data Models
[Source: docs/architecture.md#data-models]

**MindsetTag Model:**
```typescript
interface MindsetTag {
  id: string;
  tradeId: string;
  tag: MindsetTagType;
  intensity: 'LOW' | 'MEDIUM' | 'HIGH';
  createdAt: Date;
  updatedAt: Date;
}

enum MindsetTagType {
  // Positive States
  DISCIPLINED = 'DISCIPLINED',
  PATIENT = 'PATIENT',
  CONFIDENT = 'CONFIDENT',
  FOCUSED = 'FOCUSED',
  CALM = 'CALM',
  ANALYTICAL = 'ANALYTICAL',
  
  // Negative States
  ANXIOUS = 'ANXIOUS',
  FOMO = 'FOMO',
  GREEDY = 'GREEDY',
  FEARFUL = 'FEARFUL',
  IMPULSIVE = 'IMPULSIVE',
  REVENGE_TRADING = 'REVENGE_TRADING',
  OVERCONFIDENT = 'OVERCONFIDENT',
  
  // Neutral States
  NEUTRAL = 'NEUTRAL',
  UNCERTAIN = 'UNCERTAIN',
  TIRED = 'TIRED',
  DISTRACTED = 'DISTRACTED'
}
```

**Prisma Schema Addition:**
```prisma
model MindsetTag {
  id        String         @id @default(cuid())
  tradeId   String
  tag       MindsetTagType
  intensity IntensityLevel @default(MEDIUM)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  
  trade Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  
  @@unique([tradeId, tag])
}

enum IntensityLevel {
  LOW
  MEDIUM
  HIGH
}
```

### API Specifications
[Source: docs/architecture.md#api-specification]

**Enhanced POST /api/trades**
- Request body includes mindsetTags array
- Validates tag selection and intensity levels
- Creates trade and related mindset tags atomically
- Returns trade with complete mindset analysis

**PATCH /api/trades/{tradeId}/mindset**
- Updates mindset tags for existing trade
- Request body: array of MindsetTag updates
- Validates tag uniqueness per trade
- Returns updated mindset tags with trade context

**GET /api/mindset-tags/stats**
- Returns mindset tag usage statistics
- Includes performance correlation data
- Provides frequency analysis over time
- Supports date range filtering

### Form Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**MindsetTagSelector Component:**
```typescript
interface MindsetTagSelectorProps {
  selectedTags: Array<{ tag: MindsetTagType; intensity: IntensityLevel }>;
  onTagsChange: (tags: Array<{ tag: MindsetTagType; intensity: IntensityLevel }>) => void;
  maxSelections?: number;
  disabled?: boolean;
}

// Key features:
// - Visual tag cloud with color coding
// - Multi-select with intensity sliders
// - Search/filter functionality
// - Tag categories (positive/negative/neutral)
// - Quick selection presets for common combinations
// - Validation feedback for tag limits
```

**MindsetTagDisplay Component:**
```typescript
interface MindsetTagDisplayProps {
  tags: MindsetTag[];
  showIntensity?: boolean;
  compact?: boolean;
  onClick?: (tag: MindsetTag) => void;
}

// Visual specifications:
// - Color-coded tags by category
// - Intensity indicators (dots/bars)
// - Compact mode for list views
// - Detailed mode for trade analysis
// - Hover effects with tag descriptions
```

### Psychological Framework Integration
[Source: docs/architecture.md#ui-ux-specification]

**Dr. Alexander Elder's Mind Management:**
- Pre-trade psychological assessment
- Post-trade emotional analysis (future enhancement)
- Pattern recognition for emotional triggers
- Performance correlation with psychological states

**Tag Categories and Colors:**
```typescript
const getMindsetTagStyle = (tag: MindsetTagType) => {
  const positiveStates = ['DISCIPLINED', 'PATIENT', 'CONFIDENT', 'FOCUSED', 'CALM', 'ANALYTICAL'];
  const negativeStates = ['ANXIOUS', 'FOMO', 'GREEDY', 'FEARFUL', 'IMPULSIVE', 'REVENGE_TRADING', 'OVERCONFIDENT'];
  
  if (positiveStates.includes(tag)) {
    return { backgroundColor: '#10b981', category: 'positive' }; // emerald
  } else if (negativeStates.includes(tag)) {
    return { backgroundColor: '#ef4444', category: 'negative' }; // red
  } else {
    return { backgroundColor: '#6b7280', category: 'neutral' }; // gray
  }
};
```

### Analytics Integration
[Source: docs/architecture.md#data-models]

**Mindset Performance Analysis:**
```typescript
interface MindsetPerformanceStats {
  tag: MindsetTagType;
  tradeCount: number;
  winRate: number;
  averageReturn: number;
  riskAdjustedReturn: number;
  frequency: number;
}

const analyzeMindsetPerformance = (
  trades: TradeWithTags[]
): MindsetPerformanceStats[] => {
  // Group trades by mindset tags
  // Calculate performance metrics for each tag
  // Return sorted by performance impact
};
```

### File Locations
- Mindset tag types: `packages/shared/src/types/mindset.ts`
- Mindset tag API: `apps/api/src/routes/trades.ts` (enhancement)
- MindsetTagSelector: `apps/web/src/components/MindsetTagSelector.tsx`
- MindsetTagDisplay: `apps/web/src/components/MindsetTagDisplay.tsx`
- Updated TradeForm: `apps/web/src/components/TradeForm.tsx`
- Mindset analytics: `apps/web/src/components/MindsetAnalytics.tsx`

### User Experience Considerations
[Source: docs/architecture.md#ui-ux-specification]

**Mindset Awareness Design:**
- Non-judgmental language in tag descriptions
- Educational tooltips about emotional trading
- Progressive disclosure to avoid overwhelming new users
- Quick selection patterns for experienced users
- Integration with overall trade entry workflow

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- Mindset tag selection and validation
- Multiple tag selection with intensity levels
- Tag display in various UI contexts
- Performance correlation calculations
- Tag-based filtering functionality
- Integration with trade creation workflow

**Tag Selection Test Cases:**
```typescript
// Test valid mindset tag combination
{
  selectedTags: [
    { tag: 'DISCIPLINED', intensity: 'HIGH' },
    { tag: 'FOCUSED', intensity: 'MEDIUM' }
  ],
  shouldValidate: true,
  shouldSave: true
}

// Test conflicting tag combination
{
  selectedTags: [
    { tag: 'DISCIPLINED', intensity: 'HIGH' },
    { tag: 'IMPULSIVE', intensity: 'HIGH' }
  ],
  shouldValidate: false,
  warningMessage: 'Conflicting psychological states detected'
}
```

#### Testing Standards
- Test all mindset tag types and intensities
- Verify tag combination validation logic
- Test performance correlation accuracy
- Mock tag-based filtering operations
- E2E test covers complete mindset workflow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_