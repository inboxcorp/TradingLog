# Story 2.3: Display Total Active Risk on Dashboard (6% Rule)

## Status
Draft

## Story
**As a** trader,  
**I want** to see the total combined risk of all my active trades on my dashboard,  
**so that** I can manage my overall account exposure at a glance.

## Acceptance Criteria

1. The dashboard contains a widget that sums the saved risk values of all "active" trades
2. The widget displays the total risk as a monetary value and as a percentage of total equity
3. The widget's color changes (e.g., from green to yellow to red) as the total risk approaches the 6% limit
4. This widget updates whenever a new trade is added or an existing trade is closed

## Tasks / Subtasks

- [ ] Task 1: Implement backend API for portfolio risk aggregation (AC: 1, 4)
  - [ ] Create GET /api/user/portfolio-risk endpoint
  - [ ] Calculate total active risk using Decimal.js precision
  - [ ] Include individual trade risk breakdown in response
  - [ ] Add caching for performance optimization
  - [ ] Return risk percentage calculation against current equity

- [ ] Task 2: Create portfolio risk dashboard widget (AC: 1, 2, 3)
  - [ ] Build PortfolioRiskWidget component
  - [ ] Display total risk amount and percentage prominently
  - [ ] Implement dynamic color coding based on risk levels
  - [ ] Add breakdown view showing individual trade contributions
  - [ ] Include 6% limit indicator and progress bar

- [ ] Task 3: Implement real-time risk updates (AC: 4)
  - [ ] Add portfolio risk to global state management
  - [ ] Update widget when trades are created/closed/modified
  - [ ] Implement optimistic UI updates for responsiveness
  - [ ] Add automatic refresh with debouncing
  - [ ] Handle concurrent updates gracefully

- [ ] Task 4: Add risk level warnings and alerts (AC: 3)
  - [ ] Create risk level thresholds (safe/warning/danger)
  - [ ] Implement visual warning system with colors
  - [ ] Add notification when approaching 6% limit
  - [ ] Include educational content about portfolio risk
  - [ ] Prevent new trades when 6% limit exceeded

- [ ] Task 5: Integrate with dashboard layout (AC: 1, 2, 3, 4)
  - [ ] Add PortfolioRiskWidget to main dashboard
  - [ ] Ensure responsive design for mobile/desktop
  - [ ] Position prominently for visibility
  - [ ] Integrate with existing dashboard components
  - [ ] Maintain consistent design system

- [ ] Task 6: Write comprehensive tests (AC: 1, 2, 3, 4)
  - [ ] Backend unit tests for portfolio risk calculations
  - [ ] Backend integration tests for risk aggregation endpoint
  - [ ] Frontend component tests for PortfolioRiskWidget
  - [ ] E2E test for portfolio risk workflow
  - [ ] Test real-time updates and state synchronization

## Dev Notes

### Previous Story Context
Story 2.2 established stop-loss adjustment functionality. This story implements the 6% portfolio risk rule, building upon the individual trade risk calculations from Stories 2.1 and 2.2.

### Portfolio Risk Calculation
[Source: docs/architecture.md#critical-implementation-requirements]

**Portfolio Risk Aggregation:**
```typescript
import Decimal from 'decimal.js';

interface PortfolioRisk {
  totalRiskAmount: number;
  totalRiskPercentage: number;
  exceedsLimit: boolean;
  riskLevel: 'SAFE' | 'WARNING' | 'DANGER';
  userEquity: number;
  activeTrades: Array<{
    id: string;
    symbol: string;
    riskAmount: number;
    riskPercentage: number;
  }>;
}

const calculatePortfolioRisk = (
  activeTrades: Trade[], 
  userEquity: number
): PortfolioRisk => {
  const totalRiskAmount = activeTrades.reduce((total, trade) => 
    new Decimal(total).plus(trade.riskAmount).toNumber(), 0
  );
  
  const totalRiskPercentage = new Decimal(totalRiskAmount)
    .dividedBy(userEquity)
    .times(100)
    .toNumber();
    
  const riskLevel = totalRiskPercentage > 6 ? 'DANGER' : 
                   totalRiskPercentage > 4.5 ? 'WARNING' : 'SAFE';
    
  return {
    totalRiskAmount,
    totalRiskPercentage,
    exceedsLimit: totalRiskPercentage > 6,
    riskLevel,
    userEquity,
    activeTrades: activeTrades.map(trade => ({
      id: trade.id,
      symbol: trade.symbol,
      riskAmount: trade.riskAmount,
      riskPercentage: new Decimal(trade.riskAmount)
        .dividedBy(userEquity)
        .times(100)
        .toNumber()
    }))
  };
};
```

### API Specifications
[Source: docs/architecture.md#api-specification]

**GET /api/user/portfolio-risk**
- Returns current portfolio risk calculation
- Requires Supabase JWT authentication
- Includes individual trade risk breakdown
- Response: PortfolioRisk object with all calculations

### Frontend Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**PortfolioRiskWidget Component:**
```typescript
interface PortfolioRiskWidgetProps {
  portfolioRisk: PortfolioRisk;
  onRefresh?: () => void;
}

// Visual specifications:
// - Green: Total risk < 3%
// - Yellow: Total risk 3% - 6%  
// - Red: Total risk > 6%
// - Circular progress indicator showing 6% limit
// - Expandable breakdown of individual trade risks
// - Clear monetary amounts and percentages
```

**Risk Level Styling:**
```typescript
const getRiskLevelStyle = (riskLevel: string) => {
  switch (riskLevel) {
    case 'SAFE':
      return { 
        backgroundColor: '#10b981', // emerald-500
        textColor: '#ffffff',
        icon: 'shield-check'
      };
    case 'WARNING':
      return { 
        backgroundColor: '#f59e0b', // amber-500
        textColor: '#ffffff',
        icon: 'exclamation-triangle'
      };
    case 'DANGER':
      return { 
        backgroundColor: '#ef4444', // red-500
        textColor: '#ffffff',
        icon: 'exclamation-circle'
      };
  }
};
```

### Dashboard Integration
[Source: docs/architecture.md#ui-ux-specification]

**Dashboard Widget Layout:**
- Position portfolio risk widget prominently in top section
- Size appropriately for both desktop and mobile viewports
- Include tooltip/expandable details for trade breakdown
- Integrate with overall dashboard refresh cycle
- Maintain consistent spacing with other dashboard widgets

### Risk Threshold Configuration
[Source: docs/architecture.md#critical-implementation-requirements]

**Risk Level Thresholds:**
- SAFE: 0% - 3% portfolio risk (green)
- WARNING: 3.1% - 6% portfolio risk (yellow/amber)
- DANGER: 6.1%+ portfolio risk (red)
- Block new trade creation when in DANGER zone

### File Locations
- Portfolio risk types: `packages/shared/src/types/index.ts`
- Portfolio risk API: `apps/api/src/routes/users.ts`
- Risk calculations: `packages/shared/src/utils/calculations.ts`
- PortfolioRiskWidget: `apps/web/src/components/PortfolioRiskWidget.tsx`
- Updated Dashboard: `apps/web/src/pages/Dashboard.tsx`
- Risk context: `apps/web/src/contexts/RiskContext.tsx`

### State Management Integration
[Source: docs/architecture.md#frontend-architecture]

**Global Risk State:**
```typescript
interface RiskContextState {
  portfolioRisk: PortfolioRisk | null;
  isLoading: boolean;
  lastUpdated: Date | null;
  refreshPortfolioRisk: () => Promise<void>;
}

// Integration points:
// - Update on trade creation (Story 1.2)
// - Update on trade closing (Story 1.3)
// - Update on stop-loss adjustment (Story 2.2)
// - Automatic refresh on dashboard load
```

### Performance Considerations
[Source: docs/architecture.md#security-and-performance]

**Optimization Strategy:**
- Cache portfolio risk calculation for 30 seconds
- Use optimistic updates for immediate UI feedback
- Debounce rapid updates to prevent API spam
- Implement background refresh when dashboard is active
- Use React Query for efficient state management

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- Portfolio risk aggregation with multiple trades
- Decimal precision in total risk calculations
- Real-time updates when trades change
- Risk level threshold accuracy
- Widget color changes at boundaries
- Performance with large numbers of active trades

**Risk Calculation Test Cases:**
```typescript
// Test portfolio with multiple trades
{
  activeTrades: [
    { riskAmount: 150, symbol: 'AAPL' },
    { riskAmount: 250, symbol: 'TSLA' },
    { riskAmount: 100, symbol: 'NVDA' }
  ],
  userEquity: 10000,
  expectedTotalRisk: 500,
  expectedPercentage: 5.0,
  expectedLevel: 'WARNING',
  shouldExceedLimit: false
}
```

#### Testing Standards
- Test aggregation with various trade combinations
- Verify Decimal.js precision in portfolio calculations
- Test real-time state updates and synchronization
- Test risk level thresholds and color changes
- E2E test covers complete dashboard interaction

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_