# Story 2.2: Adjust Stop-Loss on an Active Trade

## Status
Draft

## Story
**As a** trader,  
**I want** to adjust the stop-loss on my active trades in the direction of the trade,  
**so that** I can lock in profits or reduce my initial risk.

## Acceptance Criteria

1. Active trades in the journal have an "Adjust Stop" option
2. The user can enter a new stop-loss price
3. The system validates that the new stop can only be moved in the direction of the trade (e.g., for a long position, the new stop must be higher than the old stop)
4. Upon a valid adjustment, the trade's risk is recalculated and the record is updated

## Tasks / Subtasks

- [ ] Task 1: Implement backend API for stop-loss adjustment (AC: 3, 4)
  - [ ] Create PATCH /api/trades/{id} endpoint for stop-loss updates
  - [ ] Add validation logic for stop-loss direction rules
  - [ ] Recalculate risk amount using Decimal.js
  - [ ] Update trade record with new stop-loss and risk
  - [ ] Return updated trade with recalculated values

- [ ] Task 2: Create adjust stop-loss modal component (AC: 2)
  - [ ] Build AdjustStopModal with current stop-loss display
  - [ ] Add new stop-loss price input field
  - [ ] Show current vs. new risk calculation
  - [ ] Display validation rules to user
  - [ ] Handle error states and validation messages

- [ ] Task 3: Add adjust functionality to trade list (AC: 1)
  - [ ] Add "Adjust Stop" button to active trade items
  - [ ] Integrate with AdjustStopModal component
  - [ ] Update trade display after successful adjustment
  - [ ] Show success notification with new risk amount

- [ ] Task 4: Implement stop-loss validation logic (AC: 3)
  - [ ] Create validation function for stop-loss direction
  - [ ] Add frontend real-time validation
  - [ ] Implement backend validation with clear error messages
  - [ ] Handle edge cases (same price, minimal movement)

- [ ] Task 5: Write comprehensive tests (AC: 1, 2, 3, 4)
  - [ ] Backend unit tests for stop-loss validation rules
  - [ ] Backend integration tests for adjustment endpoint
  - [ ] Frontend component tests for AdjustStopModal
  - [ ] E2E test for complete stop-loss adjustment workflow

## Dev Notes

### Previous Story Context
Story 2.1 established risk calculation and validation. This story extends active trade management to allow stop-loss adjustments while maintaining risk management discipline.

### Stop-Loss Validation Rules
[Source: docs/architecture.md#critical-implementation-requirements]

**Direction Validation Logic:**
```typescript
const validateStopLossAdjustment = (
  trade: Trade, 
  newStopLoss: number
): { isValid: boolean; error?: string } => {
  const currentStop = new Decimal(trade.stopLoss);
  const newStop = new Decimal(newStopLoss);
  const entry = new Decimal(trade.entryPrice);
  
  if (trade.direction === 'LONG') {
    // For LONG trades, new stop must be higher (closer to/above entry)
    if (newStop.lte(currentStop)) {
      return { isValid: false, error: 'New stop-loss must be higher for LONG positions' };
    }
    // Optional: Prevent stop above entry (converts to profit lock)
    if (newStop.gt(entry)) {
      return { isValid: true }; // Allow profit locking
    }
  } else {
    // For SHORT trades, new stop must be lower (closer to/below entry)
    if (newStop.gte(currentStop)) {
      return { isValid: false, error: 'New stop-loss must be lower for SHORT positions' };
    }
    if (newStop.lt(entry)) {
      return { isValid: true }; // Allow profit locking
    }
  }
  
  return { isValid: true };
};
```

### API Specifications
[Source: docs/architecture.md#api-specification]

**PATCH /api/trades/{tradeId}**
- Updates trade stop-loss with validation
- Request body: { stopLoss: number }
- Validates direction rules and ownership
- Recalculates and updates risk amount
- Returns updated trade with new risk calculation

### Risk Recalculation
[Source: docs/architecture.md#data-models]

**Updated Risk Calculation:**
```typescript
const recalculateTradeRisk = (trade: Trade, newStopLoss: number): number => {
  return new Decimal(trade.entryPrice)
    .minus(newStopLoss)
    .abs()
    .times(trade.positionSize)
    .toNumber();
};
```

### Frontend Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**AdjustStopModal Component:**
```typescript
interface AdjustStopModalProps {
  trade: Trade;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: (updatedTrade: Trade) => void;
}

// Features:
// - Current stop-loss display
// - New stop-loss input with validation
// - Risk comparison (current vs. new)
// - Clear validation messaging
// - Confirmation before submission
```

### File Locations
- Stop-loss validation: `packages/shared/src/utils/validation.ts`
- AdjustStopModal: `apps/web/src/components/AdjustStopModal.tsx`
- API enhancement: `apps/api/src/routes/trades.ts`
- Updated TradeList: `apps/web/src/components/TradeList.tsx`

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- LONG position stop-loss direction validation
- SHORT position stop-loss direction validation
- Risk recalculation accuracy with Decimal.js
- Edge cases: stop-loss at entry price
- Profit locking scenarios (stop above/below entry)

#### Testing Standards
- Test validation rules for both trade directions
- Verify risk recalculation precision
- Test form validation and error messaging
- E2E test covers complete adjustment workflow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_