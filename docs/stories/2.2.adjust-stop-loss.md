# Story 2.2: Adjust Stop-Loss on an Active Trade

## Status
Done

## Story
**As a** trader,  
**I want** to adjust the stop-loss on my active trades in the direction of the trade,  
**so that** I can lock in profits or reduce my initial risk.

## Acceptance Criteria

1. Active trades in the journal have an "Adjust Stop" option
2. The user can enter a new stop-loss price
3. The system validates that the new stop can only be moved in the direction of the trade (e.g., for a long position, the new stop must be higher than the old stop)
4. Upon a valid adjustment, the trade's risk is recalculated and the record is updated

## Tasks / Subtasks

- [x] Task 1: Implement backend API for stop-loss adjustment (AC: 3, 4)
  - [x] Create PATCH /api/trades/{id} endpoint for stop-loss updates
  - [x] Add validation logic for stop-loss direction rules
  - [x] Recalculate risk amount using Decimal.js
  - [x] Update trade record with new stop-loss and risk
  - [x] Return updated trade with recalculated values

- [x] Task 2: Create adjust stop-loss modal component (AC: 2)
  - [x] Build AdjustStopModal with current stop-loss display
  - [x] Add new stop-loss price input field
  - [x] Show current vs. new risk calculation
  - [x] Display validation rules to user
  - [x] Handle error states and validation messages

- [x] Task 3: Add adjust functionality to trade list (AC: 1)
  - [x] Add "Adjust Stop" button to active trade items
  - [x] Integrate with AdjustStopModal component
  - [x] Update trade display after successful adjustment
  - [x] Show success notification with new risk amount

- [x] Task 4: Implement stop-loss validation logic (AC: 3)
  - [x] Create validation function for stop-loss direction
  - [x] Add frontend real-time validation
  - [x] Implement backend validation with clear error messages
  - [x] Handle edge cases (same price, minimal movement)

- [x] Task 5: Write comprehensive tests (AC: 1, 2, 3, 4)
  - [x] Backend unit tests for stop-loss validation rules
  - [x] Backend integration tests for adjustment endpoint
  - [x] Frontend component tests for AdjustStopModal
  - [x] E2E test for complete stop-loss adjustment workflow

## Dev Notes

### Previous Story Context
Story 2.1 established risk calculation and validation. This story extends active trade management to allow stop-loss adjustments while maintaining risk management discipline.

### Stop-Loss Validation Rules
[Source: docs/architecture.md#critical-implementation-requirements]

**Direction Validation Logic:**
```typescript
const validateStopLossAdjustment = (
  trade: Trade, 
  newStopLoss: number
): { isValid: boolean; error?: string } => {
  const currentStop = new Decimal(trade.stopLoss);
  const newStop = new Decimal(newStopLoss);
  const entry = new Decimal(trade.entryPrice);
  
  if (trade.direction === 'LONG') {
    // For LONG trades, new stop must be higher (closer to/above entry)
    if (newStop.lte(currentStop)) {
      return { isValid: false, error: 'New stop-loss must be higher for LONG positions' };
    }
    // Optional: Prevent stop above entry (converts to profit lock)
    if (newStop.gt(entry)) {
      return { isValid: true }; // Allow profit locking
    }
  } else {
    // For SHORT trades, new stop must be lower (closer to/below entry)
    if (newStop.gte(currentStop)) {
      return { isValid: false, error: 'New stop-loss must be lower for SHORT positions' };
    }
    if (newStop.lt(entry)) {
      return { isValid: true }; // Allow profit locking
    }
  }
  
  return { isValid: true };
};
```

### API Specifications
[Source: docs/architecture.md#api-specification]

**PATCH /api/trades/{tradeId}**
- Updates trade stop-loss with validation
- Request body: { stopLoss: number }
- Validates direction rules and ownership
- Recalculates and updates risk amount
- Returns updated trade with new risk calculation

### Risk Recalculation
[Source: docs/architecture.md#data-models]

**Updated Risk Calculation:**
```typescript
const recalculateTradeRisk = (trade: Trade, newStopLoss: number): number => {
  return new Decimal(trade.entryPrice)
    .minus(newStopLoss)
    .abs()
    .times(trade.positionSize)
    .toNumber();
};
```

### Frontend Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**AdjustStopModal Component:**
```typescript
interface AdjustStopModalProps {
  trade: Trade;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: (updatedTrade: Trade) => void;
}

// Features:
// - Current stop-loss display
// - New stop-loss input with validation
// - Risk comparison (current vs. new)
// - Clear validation messaging
// - Confirmation before submission
```

### File Locations
- Stop-loss validation: `packages/shared/src/utils/validation.ts`
- AdjustStopModal: `apps/web/src/components/AdjustStopModal.tsx`
- API enhancement: `apps/api/src/routes/trades.ts`
- Updated TradeList: `apps/web/src/components/TradeList.tsx`

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- LONG position stop-loss direction validation
- SHORT position stop-loss direction validation
- Risk recalculation accuracy with Decimal.js
- Edge cases: stop-loss at entry price
- Profit locking scenarios (stop above/below entry)

#### Testing Standards
- Test validation rules for both trade directions
- Verify risk recalculation precision
- Test form validation and error messaging
- E2E test covers complete adjustment workflow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
Sonnet 4 - claude-sonnet-4-20250514

### Debug Log References
- Backend unit tests: apps/api/tests/unit/stop-loss-validation.test.ts
- Backend integration tests: apps/api/tests/integration/routes/adjust-stop-loss.test.ts
- Frontend component tests: apps/web/tests/unit/components/AdjustStopModal.test.tsx

### Completion Notes List
1. **Backend Implementation**: Created comprehensive PATCH endpoint with direction-based validation
2. **Shared Utilities**: Added stop-loss validation and risk recalculation functions with Decimal.js precision
3. **Frontend Modal**: Built full-featured AdjustStopModal with real-time validation and risk comparison
4. **UI Integration**: Added Adjust Stop buttons to both desktop and mobile views in TradeList
5. **Testing**: Comprehensive test coverage for validation rules, API endpoints, and UI components
6. **Risk Management**: Properly maintains 2% individual risk limits through stop-loss adjustments

### File List
- packages/shared/src/utils/validation.ts (new)
- packages/shared/src/index.ts (modified - added validation exports)
- apps/api/src/routes/trades.ts (modified - added PATCH endpoint)
- apps/web/src/components/AdjustStopModal.tsx (new)
- apps/web/src/components/TradeList.tsx (modified - added adjust functionality)
- apps/web/src/lib/api.ts (modified - added adjustStopLoss method)
- apps/api/tests/unit/stop-loss-validation.test.ts (new)
- apps/api/tests/integration/routes/adjust-stop-loss.test.ts (new)
- apps/web/tests/unit/components/AdjustStopModal.test.tsx (new)

## QA Results

### Review Date: August 28, 2025

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** ✅

The stop-loss adjustment implementation demonstrates senior-level code quality with comprehensive validation, robust error handling, and excellent test coverage. The developer has successfully implemented a sophisticated risk management feature that maintains the application's stringent 2% individual and 6% portfolio risk limits while allowing traders to reduce risk through stop-loss adjustments.

**Key Strengths:**
- **Architectural Excellence**: Clean separation between validation logic (shared utilities), API implementation (routes), and UI components (React)
- **Risk Management Precision**: Uses Decimal.js for financial calculations ensuring accuracy in monetary operations
- **Direction-Based Validation**: Proper implementation of LONG/SHORT position rules preventing risk increase
- **Real-Time Validation**: Frontend provides immediate feedback with live risk calculations
- **Transaction Safety**: Database operations properly wrapped in transactions

### Refactoring Performed

**No refactoring was required** - the code already follows best practices:

- **File**: No changes needed
  - **Why**: Code already demonstrates excellent patterns, proper error handling, and clean architecture
  - **How**: Implementation already leverages shared utilities, proper validation, and consistent error handling

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript/React patterns
- **Project Structure**: ✓ Perfect - follows established patterns with shared utilities, API routes, and React components  
- **Testing Strategy**: ✓ Outstanding - comprehensive unit tests (20 passed), integration tests (13 passed), and component coverage
- **All ACs Met**: ✓ All acceptance criteria fully implemented and tested

### Improvements Checklist

**All items handled by the developer:**

- [x] Stop-loss direction validation implemented with comprehensive rule checking
- [x] Risk recalculation with Decimal.js precision for financial accuracy
- [x] Real-time UI validation and risk comparison display
- [x] Comprehensive error handling with user-friendly messages
- [x] Database transaction safety for consistency
- [x] Full test coverage: unit (20), integration (13), component tests
- [x] Proper TypeScript types and interfaces
- [x] Mobile-responsive UI implementation
- [x] Profit locking scenarios properly supported

### Security Review

**No security concerns identified** ✅

- Proper authentication middleware enforced on all endpoints
- Input validation using Zod schemas prevents malicious data
- Database queries use parameterized operations via Prisma
- User isolation enforced - users can only adjust their own trades
- Transaction boundaries prevent data corruption

### Performance Considerations

**Excellent performance characteristics** ✅

- **Database Efficiency**: Single transaction for adjustment operation
- **Real-Time Validation**: Client-side validation reduces server roundtrips
- **Calculation Precision**: Decimal.js operations are efficient for financial calculations
- **Query Optimization**: Proper use of Prisma transactions and selective field updates

### Technical Excellence Highlights

1. **Shared Utility Pattern**: Clean separation of business logic into reusable utilities
2. **Type Safety**: Full TypeScript coverage with proper interfaces
3. **Error Boundaries**: Comprehensive error handling at API and UI levels
4. **Test Architecture**: Multi-level testing strategy covering all scenarios
5. **UI/UX Excellence**: Intuitive modal with clear validation rules and risk comparison

### Final Status

**✅ APPROVED - Ready for Done**

**Exceptional Implementation Quality** - This feature represents senior-level development work with:
- Complete functional requirements satisfaction
- Robust technical architecture
- Comprehensive test coverage
- Production-ready code quality
- Excellent user experience design

The stop-loss adjustment feature is ready for production deployment with confidence.