# Story 2.1: Implement Per-Trade Risk Calculation (2% Rule)

## Status
Draft

## Story
**As a** trader,  
**I want** the app to automatically calculate the risk of a new trade and warn me if it exceeds 2% of my equity,  
**so that** I can maintain per-trade discipline before committing to a position.

## Acceptance Criteria

1. When filling out the "New Trade" form, the system calculates the monetary risk ((entry price - stop loss) * size)
2. The system compares the calculated risk to 2% of the user's current total equity
3. If the risk exceeds 2%, a prominent visual warning is displayed on the form before the user saves the trade
4. The calculated risk amount is saved with the trade record

## Tasks / Subtasks

- [ ] Task 1: Enhance risk calculation logic (AC: 1, 4)
  - [ ] Update calculateTradeRisk function to use Decimal.js precision
  - [ ] Add risk percentage calculation against user equity
  - [ ] Ensure risk amount is saved with trade record
  - [ ] Add validation for edge cases (zero values, negative prices)

- [ ] Task 2: Implement backend risk validation (AC: 2, 3)
  - [ ] Add 2% risk validation to POST /api/trades endpoint
  - [ ] Return specific error messages for risk violations
  - [ ] Include risk details in error response
  - [ ] Maintain transaction integrity during validation

- [ ] Task 3: Create risk warning UI component (AC: 3)
  - [ ] Build RiskWarning component with visual prominence
  - [ ] Add different warning levels (info, warning, danger)
  - [ ] Show risk amount and percentage clearly
  - [ ] Include educational messaging about risk limits

- [ ] Task 4: Integrate real-time risk calculation in TradeForm (AC: 1, 2, 3)
  - [ ] Add real-time risk calculation as user types
  - [ ] Display current risk amount and percentage
  - [ ] Show warning banner when 2% exceeded
  - [ ] Prevent form submission when risk limits violated

- [ ] Task 5: Add risk display to trade list and dashboard (AC: 4)
  - [ ] Show risk amount in trade list items
  - [ ] Add risk percentage display
  - [ ] Create risk status indicators (safe/warning/danger)
  - [ ] Update dashboard to show per-trade risk levels

- [ ] Task 6: Write comprehensive tests (AC: 1, 2, 3, 4)
  - [ ] Unit tests for Decimal.js risk calculations
  - [ ] Backend tests for 2% validation logic
  - [ ] Frontend tests for RiskWarning component
  - [ ] Integration tests for real-time calculation
  - [ ] E2E tests for risk warning workflow

## Dev Notes

### Previous Story Context
Story 1.2 established basic trade creation with risk calculation. This story enhances that functionality to add the critical 2% per-trade risk rule with visual warnings and validation.

### Risk Calculation Enhancement
[Source: docs/architecture.md#critical-implementation-requirements]

**Enhanced Risk Calculation:**
```typescript
import Decimal from 'decimal.js';

interface RiskCalculation {
  riskAmount: number;
  riskPercentage: number;
  exceedsLimit: boolean;
  userEquity: number;
}

const calculateTradeRisk = (
  entryPrice: number, 
  stopLoss: number, 
  size: number,
  userEquity: number
): RiskCalculation => {
  const riskAmount = new Decimal(entryPrice)
    .minus(stopLoss)
    .abs()
    .times(size)
    .toNumber();
    
  const riskPercentage = new Decimal(riskAmount)
    .dividedBy(userEquity)
    .times(100)
    .toNumber();
    
  return {
    riskAmount,
    riskPercentage,
    exceedsLimit: riskPercentage > 2,
    userEquity
  };
};
```

### API Enhancement
[Source: docs/architecture.md#api-specification]

**POST /api/trades Enhanced Response:**
```typescript
// Success Response (201)
{
  trade: Trade,
  riskCalculation: RiskCalculation
}

// Risk Violation Response (400)
{
  error: "Trade risk exceeds 2% limit",
  riskAmount: number,
  riskPercentage: number,
  limit: 2,
  userEquity: number
}
```

### Frontend Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**RiskWarning Component:**
```typescript
interface RiskWarningProps {
  riskCalculation: RiskCalculation;
  level: 'info' | 'warning' | 'danger';
}

// Visual specifications:
// - Green: Risk < 1.5%
// - Yellow: Risk 1.5% - 2%  
// - Red: Risk > 2%
// - Clear messaging about risk amount and percentage
// - Educational content about risk management
```

**TradeForm Enhancement:**
```typescript
interface TradeFormState {
  entryPrice: number;
  stopLoss: number;
  positionSize: number;
  riskCalculation: RiskCalculation | null;
  canSubmit: boolean;
}

// Real-time calculation triggers:
// - On every field change (debounced)
// - Immediate feedback without API calls
// - Server validation on form submission
```

### Database Schema Addition
[Source: docs/architecture.md#data-models]

**Trade Model - Risk Fields:**
```prisma
model Trade {
  // ... existing fields
  riskAmount     Float    // Monetary risk amount
  riskPercentage Float    // Risk as % of equity at time of entry
}
```

### Validation Rules
[Source: docs/architecture.md#critical-implementation-requirements]

**Risk Validation Logic:**
1. Calculate risk using precise Decimal.js arithmetic
2. Get current user equity from database
3. Compare risk percentage to 2% limit
4. Block trade creation if limit exceeded
5. Allow override only with explicit user confirmation (future story)

### File Locations
- Enhanced calculations: `packages/shared/src/utils/calculations.ts`
- RiskWarning component: `apps/web/src/components/RiskWarning.tsx`
- Updated TradeForm: `apps/web/src/components/TradeForm.tsx`
- API enhancements: `apps/api/src/routes/trades.ts`
- Risk types: `packages/shared/src/types/index.ts`

### User Experience Considerations
[Source: docs/architecture.md#ui-ux-specification]

**Risk Warning Design:**
- Clear, non-intrusive but noticeable warnings
- Educational messaging about why 2% rule matters
- Smooth transitions when risk levels change
- Mobile-friendly warning displays
- Consistent with overall app design system

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- Decimal precision in risk calculations
- Edge cases: zero equity, negative values
- Real-time calculation performance
- Risk warning UI state changes
- Backend validation accuracy

**Risk Calculation Test Cases:**
```typescript
// Test cases for validation
{
  entryPrice: 100,
  stopLoss: 98,
  size: 100,
  equity: 10000,
  expectedRisk: 200,
  expectedPercentage: 2.0,
  shouldExceedLimit: false
}
```

#### Testing Standards
- Test all risk calculations with known values
- Verify Decimal.js precision maintenance
- Test real-time UI updates and performance
- Validate error messages and user guidance
- E2E tests cover complete risk warning flow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_