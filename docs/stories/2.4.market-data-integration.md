# Story 2.4: Integrate Market Data for Live Equity Curve

## Status
Draft

## Story
**As a** trader,  
**I want** the dashboard to display a live equity curve based on the current market price of my active positions,  
**so that** I can see my real-time performance.

## Acceptance Criteria

1. The system successfully connects to a third-party market data API
2. For each active trade, the system fetches the current market price for that asset
3. The dashboard displays a chart showing the user's total equity, which fluctuates based on the unrealized Profit/Loss of all active trades
4. The chart and equity value update automatically at a reasonable interval

## Tasks / Subtasks

- [ ] Task 1: Implement Alpha Vantage API integration (AC: 1, 2)
  - [ ] Set up Alpha Vantage API client with free tier configuration
  - [ ] Create market data service with rate limiting
  - [ ] Implement symbol price fetching with error handling
  - [ ] Add API key configuration and environment variables
  - [ ] Create fallback mechanisms for API failures

- [ ] Task 2: Create unrealized P/L calculation system (AC: 2, 3)
  - [ ] Implement calculateUnrealizedPnL function using Decimal.js
  - [ ] Create live equity calculation combining realized + unrealized
  - [ ] Add real-time position value updates
  - [ ] Handle missing market data gracefully
  - [ ] Ensure calculation precision for financial accuracy

- [ ] Task 3: Build live equity curve chart component (AC: 3)
  - [ ] Create EquityCurveChart component with time series
  - [ ] Implement responsive chart design for mobile/desktop
  - [ ] Add historical equity snapshots integration
  - [ ] Show realized vs unrealized equity breakdown
  - [ ] Include zoom/time range selection controls

- [ ] Task 4: Implement manual refresh system (AC: 4)
  - [ ] Add manual refresh button on dashboard
  - [ ] Trigger refresh on critical actions (trade open/close)
  - [ ] Show last refresh timestamp clearly
  - [ ] Add loading states during refresh operations
  - [ ] Implement user-controlled refresh frequency

- [ ] Task 5: Create market data management (AC: 1, 2, 4)
  - [ ] Build market data cache with TTL
  - [ ] Implement batch symbol requests for efficiency
  - [ ] Add market hours validation
  - [ ] Handle symbol mapping and normalization
  - [ ] Create market data status indicators

- [ ] Task 6: Write comprehensive tests (AC: 1, 2, 3, 4)
  - [ ] Unit tests for Alpha Vantage integration
  - [ ] Unit tests for unrealized P/L calculations with Decimal.js
  - [ ] Frontend component tests for EquityCurveChart
  - [ ] Integration tests for market data workflow
  - [ ] E2E test for live equity display

## Dev Notes

### Previous Story Context
Story 2.3 established portfolio risk monitoring. This story adds live market data integration to show real-time equity performance, completing the dashboard's risk and performance feedback system.

### Market Data Integration
[Source: docs/architecture.md#external-api-integration]

**Alpha Vantage Integration (Simplified Manual Refresh):**
```typescript
interface MarketDataService {
  getQuote(symbol: string): Promise<Quote>;
  getBatchQuotes(symbols: string[]): Promise<Quote[]>;
  isMarketOpen(): boolean;
}

interface Quote {
  symbol: string;
  price: number;
  timestamp: Date;
  change: number;
  changePercent: number;
}

class AlphaVantageService implements MarketDataService {
  private apiKey: string;
  private baseUrl = 'https://www.alphavantage.co/query';
  private cache = new Map<string, { quote: Quote; expiry: Date }>();
  
  async getQuote(symbol: string): Promise<Quote> {
    // Check cache first (5-minute TTL)
    const cached = this.cache.get(symbol);
    if (cached && cached.expiry > new Date()) {
      return cached.quote;
    }
    
    // Fetch from API with rate limiting
    const response = await this.fetchWithRetry(symbol);
    const quote = this.parseQuoteResponse(response);
    
    // Cache result
    this.cache.set(symbol, {
      quote,
      expiry: new Date(Date.now() + 5 * 60 * 1000) // 5 minutes
    });
    
    return quote;
  }
}
```

### Unrealized P/L Calculation
[Source: docs/architecture.md#critical-implementation-requirements]

**CRITICAL: Live Equity Calculation:**
```typescript
import Decimal from 'decimal.js';

interface LiveEquityCalculation {
  totalEquity: number;
  realizedEquity: number;
  unrealizedPnL: number;
  totalUnrealizedValue: number;
  activeTrades: Array<{
    id: string;
    symbol: string;
    unrealizedPnL: number;
    currentValue: number;
  }>;
}

const calculateUnrealizedPnL = (
  trade: Trade, 
  currentPrice: number
): number => {
  const entryDecimal = new Decimal(trade.entryPrice);
  const currentDecimal = new Decimal(currentPrice);
  const sizeDecimal = new Decimal(trade.positionSize);
  
  if (trade.direction === 'LONG') {
    return currentDecimal.minus(entryDecimal).times(sizeDecimal).toNumber();
  } else {
    return entryDecimal.minus(currentDecimal).times(sizeDecimal).toNumber();
  }
};

const calculateLiveEquity = (
  userRealizedEquity: number,
  activeTrades: Trade[],
  quotes: Quote[]
): LiveEquityCalculation => {
  const quotesMap = new Map(quotes.map(q => [q.symbol, q.price]));
  
  let totalUnrealizedPnL = new Decimal(0);
  const tradeDetails = activeTrades.map(trade => {
    const currentPrice = quotesMap.get(trade.symbol) || trade.entryPrice;
    const unrealizedPnL = calculateUnrealizedPnL(trade, currentPrice);
    totalUnrealizedPnL = totalUnrealizedPnL.plus(unrealizedPnL);
    
    return {
      id: trade.id,
      symbol: trade.symbol,
      unrealizedPnL,
      currentValue: new Decimal(currentPrice).times(trade.positionSize).toNumber()
    };
  });
  
  const totalEquity = new Decimal(userRealizedEquity)
    .plus(totalUnrealizedPnL)
    .toNumber();
    
  return {
    totalEquity,
    realizedEquity: userRealizedEquity,
    unrealizedPnL: totalUnrealizedPnL.toNumber(),
    totalUnrealizedValue: tradeDetails.reduce((sum, trade) => 
      new Decimal(sum).plus(trade.currentValue).toNumber(), 0
    ),
    activeTrades: tradeDetails
  };
};
```

### API Specifications
[Source: docs/architecture.md#api-specification]

**GET /api/user/live-equity**
- Returns live equity calculation with market data
- Includes unrealized P/L for all active trades
- Handles market data failures gracefully
- Caches results for performance

**POST /api/market-data/refresh**
- Manually triggers market data refresh
- Updates cached quotes for user's active symbols
- Returns updated equity calculation
- Respects API rate limits

### Chart Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**EquityCurveChart Component:**
```typescript
interface EquityCurveChartProps {
  liveEquity: LiveEquityCalculation;
  equityHistory: EquitySnapshot[];
  height?: number;
  showControls?: boolean;
}

// Key features:
// - Time series chart with realized vs total equity lines
// - Real-time update indicators
// - Zoom controls for different time ranges
// - Tooltip showing P/L breakdown on hover
// - Responsive design for mobile viewing
// - Integration with chart.js or similar library
```

### Manual Refresh Strategy
[Source: User feedback: "only refresh when perform critical action on the app or explicitly put refresh button on UI"]

**Refresh Triggers:**
1. Manual refresh button click
2. Trade creation (automatic)
3. Trade closing (automatic)
4. Stop-loss adjustment (automatic)
5. Dashboard page load/focus

**No Background Refresh:**
- No cron jobs or background processes
- No automatic interval-based updates
- Cost-optimized approach for Alpha Vantage free tier
- User controls when market data is fetched

### Rate Limiting and Cost Optimization
[Source: docs/architecture.md#external-api-integration]

**Alpha Vantage Free Tier Limits:**
- 25 requests per day (timestamp tracking required)
- 5 API calls per minute
- Implement request queuing and batching
- Cache responses for 5+ minutes
- Show rate limit status to user

### Error Handling Strategy
[Source: docs/architecture.md#critical-implementation-requirements]

**Market Data Failure Handling:**
```typescript
interface MarketDataError {
  type: 'RATE_LIMIT' | 'API_DOWN' | 'INVALID_SYMBOL' | 'NETWORK_ERROR';
  message: string;
  retryAfter?: number;
}

// Fallback strategies:
// 1. Use last known price from cache
// 2. Use entry price as current price
// 3. Show stale data warnings
// 4. Graceful degradation to realized equity only
```

### File Locations
- Market data types: `packages/shared/src/types/market.ts`
- Alpha Vantage service: `apps/api/src/services/marketData.ts`
- Live equity calculations: `packages/shared/src/utils/calculations.ts`
- EquityCurveChart: `apps/web/src/components/EquityCurveChart.tsx`
- Market data API: `apps/api/src/routes/marketData.ts`
- Live equity context: `apps/web/src/contexts/LiveEquityContext.tsx`

### Security Considerations
[Source: docs/architecture.md#security-and-performance]

**API Security:**
- Store Alpha Vantage API key securely in environment variables
- Validate and sanitize symbol inputs
- Implement request rate limiting on backend
- Add API usage monitoring and alerts
- Never expose API keys in frontend code

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- Alpha Vantage API integration and error handling
- Unrealized P/L calculation precision
- Live equity calculation with multiple trades
- Chart rendering and real-time updates
- Manual refresh functionality
- Rate limiting and caching behavior

**Market Data Test Cases:**
```typescript
// Test live equity with unrealized P/L
{
  userRealizedEquity: 10000,
  activeTrades: [
    {
      symbol: 'AAPL',
      direction: 'LONG',
      entryPrice: 150,
      positionSize: 10,
      currentPrice: 155
    }
  ],
  expectedUnrealizedPnL: 50,
  expectedTotalEquity: 10050
}
```

#### Testing Standards
- Mock Alpha Vantage API responses in tests
- Test calculation precision with Decimal.js
- Test error scenarios and fallback behavior
- Verify rate limiting and caching functionality
- E2E test covers complete market data integration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_