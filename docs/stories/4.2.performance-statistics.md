# Story 4.2: Display Performance Statistics for Filtered Trades

## Status
Draft

## Story
**As a** trader,  
**I want** to see key performance statistics for any group of filtered trades,  
**so that** I can quantitatively understand the profitability and effectiveness of my setups.

## Acceptance Criteria

1. On the "Analysis" screen, a summary area displays statistics for the currently filtered trades
2. The system correctly calculates and displays: Win/Loss Ratio, Average Profit (for wins), and Average Loss (for losses)
3. The statistics update in real-time as the filters are changed

## Tasks / Subtasks

- [ ] Task 1: Implement performance statistics calculation engine (AC: 2)
  - [ ] Create comprehensive statistics calculation using Decimal.js
  - [ ] Implement win/loss ratio with proper handling of edge cases
  - [ ] Add average profit/loss calculations with precision
  - [ ] Create additional performance metrics (Sharpe ratio, max drawdown)
  - [ ] Add risk-adjusted performance calculations

- [ ] Task 2: Create backend analytics statistics API (AC: 1, 2, 3)
  - [ ] Add statistics calculation to GET /api/trades/analytics
  - [ ] Implement real-time statistics for filtered datasets
  - [ ] Add performance metrics caching for efficiency
  - [ ] Create statistics comparison between filter sets
  - [ ] Add historical performance trend analysis

- [ ] Task 3: Build performance statistics display component (AC: 1, 2)
  - [ ] Create PerformanceStatsWidget with visual metrics
  - [ ] Add key statistics cards with clear formatting
  - [ ] Implement performance trend indicators
  - [ ] Create comparison view for different filter sets
  - [ ] Add drill-down capabilities for detailed analysis

- [ ] Task 4: Implement real-time statistics updates (AC: 3)
  - [ ] Add reactive statistics updates when filters change
  - [ ] Implement optimistic UI updates for responsiveness
  - [ ] Add loading states during statistics calculation
  - [ ] Create debounced updates to prevent excessive API calls
  - [ ] Handle statistics calculation errors gracefully

- [ ] Task 5: Create advanced performance metrics (AC: 2)
  - [ ] Add expectancy calculation for trading system evaluation
  - [ ] Implement consecutive wins/losses tracking
  - [ ] Create profit factor and recovery factor metrics
  - [ ] Add time-based performance analysis
  - [ ] Implement benchmarking against market indices

- [ ] Task 6: Write comprehensive tests (AC: 1, 2, 3)
  - [ ] Unit tests for statistics calculation engine with Decimal.js
  - [ ] Backend integration tests for analytics statistics
  - [ ] Frontend component tests for PerformanceStatsWidget
  - [ ] E2E test for real-time statistics updates
  - [ ] Test statistics accuracy with various trade scenarios

## Dev Notes

### Previous Story Context
Story 4.1 established the analytics screen with filtering capabilities. This story adds comprehensive performance statistics that update dynamically based on the filtered trade dataset.

### Performance Statistics Engine
[Source: docs/architecture.md#critical-implementation-requirements]

**Comprehensive Statistics Calculation:**
```typescript
import Decimal from 'decimal.js';

interface PerformanceStatistics {
  // Basic Metrics
  totalTrades: number;
  winningTrades: number;
  losingTrades: number;
  breakevenTrades: number;
  
  // Win/Loss Analysis
  winRate: number; // Percentage
  lossRate: number; // Percentage
  winLossRatio: number; // Wins / Losses
  
  // Profit/Loss Metrics
  totalPnL: number;
  averageProfit: number; // Average of winning trades only
  averageLoss: number; // Average of losing trades only
  averageTrade: number; // Average of all trades
  
  // Risk-Adjusted Metrics
  expectancy: number; // (Win% × Avg Win) - (Loss% × Avg Loss)
  profitFactor: number; // Gross Profit / Gross Loss
  recoveryFactor: number; // Total PnL / Max Drawdown
  
  // Advanced Metrics
  maxWin: number;
  maxLoss: number;
  maxConsecutiveWins: number;
  maxConsecutiveLosses: number;
  currentStreak: number;
  streakType: 'WIN' | 'LOSS' | 'NONE';
  
  // Risk Metrics
  averageRisk: number;
  riskAdjustedReturn: number;
  maxDrawdown: number;
  sharpeRatio: number;
  
  // Time-based Analysis
  averageHoldTime: number; // In hours
  tradingFrequency: number; // Trades per month
  bestMonth: string;
  worstMonth: string;
}

const calculatePerformanceStatistics = (
  trades: TradeWithFullAnalysis[]
): PerformanceStatistics => {
  const closedTrades = trades.filter(t => t.status === 'CLOSED' && t.realizedPnL !== null);
  
  if (closedTrades.length === 0) {
    return getEmptyStatistics();
  }
  
  const winningTrades = closedTrades.filter(t => t.realizedPnL! > 0);
  const losingTrades = closedTrades.filter(t => t.realizedPnL! < 0);
  const breakevenTrades = closedTrades.filter(t => t.realizedPnL === 0);
  
  // Basic calculations using Decimal.js
  const totalPnL = closedTrades.reduce((sum, trade) => 
    new Decimal(sum).plus(trade.realizedPnL!).toNumber(), 0
  );
  
  const averageProfit = winningTrades.length > 0 
    ? winningTrades.reduce((sum, trade) => 
        new Decimal(sum).plus(trade.realizedPnL!).toNumber(), 0
      ) / winningTrades.length
    : 0;
  
  const averageLoss = losingTrades.length > 0
    ? Math.abs(losingTrades.reduce((sum, trade) => 
        new Decimal(sum).plus(trade.realizedPnL!).toNumber(), 0
      ) / losingTrades.length)
    : 0;
  
  // Advanced calculations
  const winRate = (winningTrades.length / closedTrades.length) * 100;
  const lossRate = (losingTrades.length / closedTrades.length) * 100;
  
  const expectancy = new Decimal(winRate / 100)
    .times(averageProfit)
    .minus(new Decimal(lossRate / 100).times(averageLoss))
    .toNumber();
  
  const grossProfit = winningTrades.reduce((sum, trade) => 
    new Decimal(sum).plus(trade.realizedPnL!).toNumber(), 0
  );
  
  const grossLoss = Math.abs(losingTrades.reduce((sum, trade) => 
    new Decimal(sum).plus(trade.realizedPnL!).toNumber(), 0
  ));
  
  const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? Infinity : 0;
  
  return {
    totalTrades: closedTrades.length,
    winningTrades: winningTrades.length,
    losingTrades: losingTrades.length,
    breakevenTrades: breakevenTrades.length,
    winRate,
    lossRate,
    winLossRatio: losingTrades.length > 0 ? winningTrades.length / losingTrades.length : Infinity,
    totalPnL,
    averageProfit,
    averageLoss,
    averageTrade: totalPnL / closedTrades.length,
    expectancy,
    profitFactor,
    recoveryFactor: calculateRecoveryFactor(closedTrades),
    maxWin: Math.max(...winningTrades.map(t => t.realizedPnL!)),
    maxLoss: Math.min(...losingTrades.map(t => t.realizedPnL!)),
    maxConsecutiveWins: calculateMaxConsecutive(closedTrades, 'WIN'),
    maxConsecutiveLosses: calculateMaxConsecutive(closedTrades, 'LOSS'),
    currentStreak: calculateCurrentStreak(closedTrades),
    streakType: getCurrentStreakType(closedTrades),
    averageRisk: calculateAverageRisk(closedTrades),
    riskAdjustedReturn: calculateRiskAdjustedReturn(closedTrades),
    maxDrawdown: calculateMaxDrawdown(closedTrades),
    sharpeRatio: calculateSharpeRatio(closedTrades),
    averageHoldTime: calculateAverageHoldTime(closedTrades),
    tradingFrequency: calculateTradingFrequency(closedTrades),
    bestMonth: findBestMonth(closedTrades),
    worstMonth: findWorstMonth(closedTrades)
  };
};
```

### API Specifications
[Source: docs/architecture.md#api-specification]

**Enhanced GET /api/trades/analytics Response:**
```typescript
interface AnalyticsResponse {
  trades: TradeWithFullAnalysis[];
  statistics: PerformanceStatistics;
  totalCount: number;
  filteredCount: number;
  comparisonStats?: {
    allTrades: PerformanceStatistics;
    filtered: PerformanceStatistics;
    improvement: number;
  };
}
```

### Frontend Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**PerformanceStatsWidget Component:**
```typescript
interface PerformanceStatsWidgetProps {
  statistics: PerformanceStatistics;
  loading?: boolean;
  showComparison?: boolean;
  compactView?: boolean;
}

// Layout structure:
// - Key metrics grid (win rate, profit factor, expectancy)
// - Secondary metrics expandable section
// - Visual indicators (gauges, progress bars)
// - Trend arrows for comparison
// - Export button for statistics
```

**StatisticCard Component:**
```typescript
interface StatisticCardProps {
  title: string;
  value: number | string;
  format: 'currency' | 'percentage' | 'ratio' | 'number';
  trend?: 'up' | 'down' | 'neutral';
  description?: string;
  benchmark?: number;
}

// Visual specifications:
// - Large, prominent value display
// - Clear metric labeling
// - Trend indicators with colors
// - Tooltip with calculation explanation
// - Responsive sizing for mobile
```

### Statistics Display Categories
[Source: docs/architecture.md#ui-ux-specification]

**Primary Metrics (Always Visible):**
- Win Rate (percentage with visual gauge)
- Total P/L (currency with trend indicator)
- Profit Factor (ratio with benchmark comparison)
- Expectancy (currency per trade)

**Secondary Metrics (Expandable):**
- Average profit/loss amounts
- Max win/loss records
- Consecutive wins/losses streaks
- Risk-adjusted returns
- Trading frequency and hold times

**Advanced Metrics (Expert Mode):**
- Sharpe ratio calculation
- Maximum drawdown analysis
- Recovery factor assessment
- Statistical significance tests

### Real-time Update Strategy
[Source: docs/architecture.md#frontend-architecture]

**Statistics Update Flow:**
```typescript
// In AnalyticsContext
const updateStatistics = useCallback(
  debounce(async (filters: TradeAnalyticsFilters) => {
    setLoading(true);
    try {
      const response = await fetchAnalytics(filters);
      setStatistics(response.statistics);
      setTrades(response.trades);
    } catch (error) {
      handleStatisticsError(error);
    } finally {
      setLoading(false);
    }
  }, 300),
  []
);

// Trigger updates on filter changes
useEffect(() => {
  updateStatistics(filters);
}, [filters, updateStatistics]);
```

### Performance Benchmarking
[Source: docs/architecture.md#critical-implementation-requirements]

**Benchmark Comparisons:**
```typescript
interface PerformanceBenchmarks {
  profitFactor: {
    excellent: 2.0,
    good: 1.5,
    acceptable: 1.25,
    poor: 1.0
  };
  winRate: {
    excellent: 70,
    good: 60,
    acceptable: 50,
    poor: 40
  };
  expectancy: {
    excellent: 0.02, // 2% per trade
    good: 0.01,      // 1% per trade
    acceptable: 0.005, // 0.5% per trade
    poor: 0          // Breakeven
  };
}

const getBenchmarkLevel = (
  metric: keyof PerformanceBenchmarks,
  value: number
): 'excellent' | 'good' | 'acceptable' | 'poor' => {
  const benchmarks = PERFORMANCE_BENCHMARKS[metric];
  if (value >= benchmarks.excellent) return 'excellent';
  if (value >= benchmarks.good) return 'good';
  if (value >= benchmarks.acceptable) return 'acceptable';
  return 'poor';
};
```

### File Locations
- Statistics types: `packages/shared/src/types/statistics.ts`
- Statistics calculations: `packages/shared/src/utils/statistics.ts`
- Enhanced analytics API: `apps/api/src/routes/analytics.ts`
- PerformanceStatsWidget: `apps/web/src/components/PerformanceStatsWidget.tsx`
- StatisticCard: `apps/web/src/components/StatisticCard.tsx`
- Updated AnalyticsScreen: `apps/web/src/pages/AnalyticsScreen.tsx`

### Statistical Accuracy Requirements
[Source: docs/architecture.md#critical-implementation-requirements]

**Decimal Precision Maintenance:**
```typescript
// CRITICAL: All financial calculations must use Decimal.js
const calculateWinRate = (trades: Trade[]): number => {
  if (trades.length === 0) return 0;
  
  const winningTrades = trades.filter(t => 
    new Decimal(t.realizedPnL || 0).gt(0)
  ).length;
  
  return new Decimal(winningTrades)
    .dividedBy(trades.length)
    .times(100)
    .toDecimalPlaces(2)
    .toNumber();
};

const calculateProfitFactor = (trades: Trade[]): number => {
  const grossProfit = trades
    .filter(t => new Decimal(t.realizedPnL || 0).gt(0))
    .reduce((sum, t) => new Decimal(sum).plus(t.realizedPnL!).toNumber(), 0);
    
  const grossLoss = Math.abs(trades
    .filter(t => new Decimal(t.realizedPnL || 0).lt(0))
    .reduce((sum, t) => new Decimal(sum).plus(t.realizedPnL!).toNumber(), 0));
    
  return grossLoss > 0 ? 
    new Decimal(grossProfit).dividedBy(grossLoss).toNumber() : 
    grossProfit > 0 ? Infinity : 0;
};
```

### Statistics Visualization
[Source: docs/architecture.md#ui-ux-specification]

**Visual Design Guidelines:**
- Clear hierarchy: primary metrics prominent, secondary metrics accessible
- Color coding: green for good performance, red for poor, yellow for neutral
- Progress bars/gauges for percentage-based metrics
- Trend indicators with arrows and color changes
- Responsive grid layout for mobile/desktop

**Metric Formatting Standards:**
```typescript
const formatStatistic = (
  value: number, 
  type: 'currency' | 'percentage' | 'ratio' | 'number'
): string => {
  switch (type) {
    case 'currency':
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
      }).format(value);
    
    case 'percentage':
      return `${value.toFixed(1)}%`;
    
    case 'ratio':
      return value === Infinity ? '∞' : value.toFixed(2);
    
    case 'number':
      return value.toLocaleString();
  }
};
```

### Advanced Analytics Features
[Source: docs/architecture.md#data-models]

**Statistical Significance Testing:**
```typescript
interface StatisticalSignificance {
  sampleSize: number;
  confidenceLevel: number;
  isSignificant: boolean;
  marginOfError: number;
  recommendation: string;
}

const assessStatisticalSignificance = (
  trades: Trade[]
): StatisticalSignificance => {
  const sampleSize = trades.length;
  
  // Require minimum 30 trades for basic significance
  const isSignificant = sampleSize >= 30;
  const confidenceLevel = Math.min(95, (sampleSize / 30) * 95);
  
  return {
    sampleSize,
    confidenceLevel,
    isSignificant,
    marginOfError: calculateMarginOfError(trades),
    recommendation: isSignificant 
      ? 'Statistics are reliable for analysis'
      : `Need ${30 - sampleSize} more trades for statistical significance`
  };
};
```

### Performance Comparison Features
[Source: docs/architecture.md#frontend-architecture]

**Filter Comparison System:**
```typescript
interface PerformanceComparison {
  baselineStats: PerformanceStatistics;
  currentStats: PerformanceStatistics;
  improvements: {
    winRate: number;
    profitFactor: number;
    expectancy: number;
    averageRisk: number;
  };
  significance: StatisticalSignificance;
}

// Use cases:
// - Compare disciplined vs emotional trades
// - Compare specific indicators performance
// - Compare different time periods
// - Compare alignment levels impact
```

### Export and Reporting
[Source: docs/architecture.md#external-api-integration]

**Statistics Export:**
```typescript
interface StatisticsExport {
  statistics: PerformanceStatistics;
  filters: TradeAnalyticsFilters;
  generatedAt: Date;
  tradeCount: number;
  dateRange: string;
}

const exportStatistics = async (
  statistics: PerformanceStatistics,
  format: 'PDF' | 'CSV' | 'JSON'
): Promise<Blob> => {
  // Generate formatted statistics report
  // Include charts and visual elements for PDF
  // Provide raw data for CSV/JSON formats
  // Add metadata and generation timestamp
};
```

### File Locations
- Statistics types: `packages/shared/src/types/statistics.ts`
- Statistics engine: `packages/shared/src/utils/statistics.ts`
- Enhanced analytics API: `apps/api/src/routes/analytics.ts`
- PerformanceStatsWidget: `apps/web/src/components/PerformanceStatsWidget.tsx`
- StatisticCard: `apps/web/src/components/StatisticCard.tsx`
- Statistics context: `apps/web/src/contexts/StatisticsContext.tsx`

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- Statistics calculation accuracy with Decimal.js
- Real-time updates when filters change
- Edge cases (no trades, all wins, all losses)
- Performance with large datasets
- Statistical significance calculations
- Export functionality for different formats

**Statistics Calculation Test Cases:**
```typescript
// Test comprehensive statistics calculation
{
  trades: [
    { realizedPnL: 100, riskAmount: 50 }, // Win, 2:1 R/R
    { realizedPnL: -50, riskAmount: 50 },  // Loss, 1:1 R/R
    { realizedPnL: 150, riskAmount: 75 }, // Win, 2:1 R/R
    { realizedPnL: -25, riskAmount: 25 }   // Loss, 1:1 R/R
  ],
  expectedStats: {
    winRate: 50,
    totalPnL: 175,
    expectancy: 43.75,
    profitFactor: 3.33,
    averageProfit: 125,
    averageLoss: 37.5
  }
}
```

#### Testing Standards
- Test all statistical calculations with known datasets
- Verify Decimal.js precision in complex calculations
- Test real-time update performance and accuracy
- Mock statistics API in frontend tests
- E2E test covers complete statistics workflow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_