# Story 1.3: Close an Active Trade

## Status
Ready for Review

## Story
**As a** trader,  
**I want** to close an active trade by recording the exit price,  
**so that** the system can calculate my realized profit or loss and update my equity.

## Acceptance Criteria

1. Active trades in the journal list have a "Close" button
2. Clicking "Close" prompts the user to enter the final exit price
3. Upon confirmation, the system calculates the realized P/L for the trade
4. The trade's status is updated to "closed," and the P/L is displayed
5. The user's total equity is correctly updated with the realized P/L

## Tasks / Subtasks

- [x] Task 1: Implement backend API for trade closing (AC: 3, 4, 5)
  - [x] Create POST /api/trades/{id}/close endpoint
  - [x] Add exit price validation and P/L calculation using Decimal.js
  - [x] Update trade status and user equity in database transaction
  - [x] Create EquitySnapshot record for historical tracking
  - [x] Return updated trade with calculated P/L

- [x] Task 2: Create close trade modal component (AC: 2)
  - [x] Build CloseTradeModal component with exit price input
  - [x] Add current market price reference (if available)
  - [x] Show P/L preview calculation
  - [x] Add confirmation dialog with trade summary
  - [x] Handle validation and error states

- [x] Task 3: Add close functionality to trade list (AC: 1)
  - [x] Add "Close" button to active trade items
  - [x] Integrate with CloseTradeModal component
  - [x] Update trade list after successful close
  - [x] Show success notification with P/L result

- [x] Task 4: Update equity display and tracking (AC: 5)
  - [x] Refresh user equity display after trade close
  - [x] Update total equity in user context/store
  - [x] Create equity snapshot for historical curve
  - [x] Ensure real-time UI updates

- [x] Task 5: Write comprehensive tests (AC: 1, 2, 3, 4, 5)
  - [x] Backend unit tests for P/L calculations with Decimal.js
  - [x] Backend integration tests for trade closing endpoint
  - [x] Frontend component tests for CloseTradeModal
  - [x] E2E test for complete trade closing workflow
  - [x] Test equity update accuracy and transaction integrity

## Dev Notes

### Previous Story Context
Story 1.2 established trade creation and the Trade model. This story extends that functionality to handle trade lifecycle completion, including P/L calculations and equity updates.

### Data Models
[Source: docs/architecture.md#data-models]

**EquitySnapshot Model (new):**
```typescript
interface EquitySnapshot {
  id: string;
  userId: string;
  totalEquity: number;
  timestamp: Date;
  source: 'TRADE_CLOSE' | 'MANUAL_UPDATE' | 'DAILY_SNAPSHOT';
}
```

**Trade Model Updates:**
- exitPrice: number | null → populated on close
- exitDate: Date | null → set to current timestamp
- realizedPnL: number | null → calculated P/L
- status: 'ACTIVE' → 'CLOSED'

### API Specifications
[Source: docs/architecture.md#api-specification]

**POST /api/trades/{tradeId}/close**
- Closes an active trade with exit price
- Request body: { exitPrice: number }
- Validates trade ownership and active status
- Calculates P/L and updates user equity
- Returns updated trade with P/L data

### P/L Calculation Requirements
[Source: docs/architecture.md#critical-implementation-requirements]

**CRITICAL: P/L Calculation Formula**
```typescript
import Decimal from 'decimal.js';

const calculatePnL = (trade: Trade, exitPrice: number): number => {
  const entryDecimal = new Decimal(trade.entryPrice);
  const exitDecimal = new Decimal(exitPrice);
  const sizeDecimal = new Decimal(trade.positionSize);
  
  if (trade.direction === 'LONG') {
    return exitDecimal.minus(entryDecimal).times(sizeDecimal).toNumber();
  } else {
    return entryDecimal.minus(exitDecimal).times(sizeDecimal).toNumber();
  }
};

const updateUserEquity = async (userId: string, pnl: number): Promise<void> => {
  await prisma.$transaction(async (tx) => {
    const user = await tx.user.findUnique({ where: { id: userId } });
    const newEquity = new Decimal(user.totalEquity).plus(pnl).toNumber();
    
    await tx.user.update({
      where: { id: userId },
      data: { totalEquity: newEquity }
    });
    
    await tx.equitySnapshot.create({
      data: {
        userId,
        totalEquity: newEquity,
        timestamp: new Date(),
        source: 'TRADE_CLOSE'
      }
    });
  });
};
```

### Frontend Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**CloseTradeModal Component:**
```typescript
interface CloseTradeModalProps {
  trade: Trade;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: (updatedTrade: Trade) => void;
}

// Key features:
// - Pre-populated with trade details
// - Exit price input with validation
// - Real-time P/L preview calculation
// - Confirmation step before final submission
// - Error handling for invalid prices
```

**TradeList Component Updates:**
- Add "Close" button for active trades only
- Disable button during close operation
- Update trade display after successful close
- Show P/L in closed trade items

### File Locations
- EquitySnapshot type: `packages/shared/src/types/index.ts`
- Trade close API: `apps/api/src/routes/trades.ts`
- P/L calculations: `packages/shared/src/utils/calculations.ts`
- CloseTradeModal: `apps/web/src/components/CloseTradeModal.tsx`
- Updated TradeList: `apps/web/src/components/TradeList.tsx`

### Database Transaction Requirements
[Source: docs/architecture.md#critical-implementation-requirements]

**CRITICAL: Atomic Operations**
All trade closing operations must be wrapped in database transactions to ensure:
- Trade status update
- User equity update  
- Equity snapshot creation
- Consistency in case of failures

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- P/L calculation precision for LONG and SHORT trades
- Decimal precision with various price points
- Concurrent trade closing prevention
- Database transaction rollback on failures
- Exit price validation (reasonable vs. market price)

**Edge Cases:**
- Closing trade with exit price equal to entry price (zero P/L)
- Very large P/L amounts and equity updates
- Network failures during close operation
- Invalid exit prices (negative, unrealistic values)

#### Testing Standards
- Test P/L calculations with known values
- Verify database transaction integrity
- Mock trade close API in frontend tests
- E2E test covers complete close workflow
- Test equity update accuracy

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Minor test configuration issues with .js import extensions resolved
- Authentication middleware configuration for test environment fixed
- Test database setup with proper user equity initialization implemented
- All backend integration tests passing for close trade functionality
- Frontend component tests created and verified for CloseTradeModal

### Completion Notes List
- Task 1: Backend API fully implemented with comprehensive trade closing endpoint
  - POST /api/trades/:tradeId/close endpoint created with full validation
  - P/L calculation using Decimal.js for financial precision
  - Database transactions ensure atomic operations (trade update + equity update + snapshot)
  - EquitySnapshot model created for historical tracking
  - Proper error handling for non-existent trades, authorization, and validation
- Task 2: CloseTradeModal component fully implemented
  - Real-time P/L preview calculation as user enters exit price
  - Two-step confirmation process (review → confirm) for safety
  - Supports both LONG and SHORT trade P/L calculations
  - Comprehensive error handling and loading states
  - Mobile-responsive design with proper form validation
- Task 3: TradeList component enhanced with close functionality
  - "Close" button added to active trades only (desktop table + mobile cards)
  - Integration with CloseTradeModal for seamless UX
  - P/L display added to show realized gains/losses for closed trades
  - Real-time updates after successful trade closure
- Task 4: Equity display automatically updates via React Query invalidation
  - User equity refreshes when CloseTradeModal completes successfully
  - EquitySnapshot records created for historical tracking
  - No additional changes needed - existing infrastructure handles updates
- Task 5: Comprehensive test suite implemented and passing
  - Backend unit tests for calculateRealizedPnL function (LONG/SHORT, decimals, edge cases)
  - Integration tests for trade closing endpoint (12 test scenarios)
  - Frontend component tests for CloseTradeModal (15 test scenarios)
  - E2E test suite for complete close trade workflow
  - All tests verify financial precision, error handling, and user experience

### File List
**Backend Files Created/Modified:**
- `packages/shared/src/types/index.ts` - Added EquitySnapshot types and CloseTradeRequest schema
- `packages/shared/src/utils/calculations.ts` - Fixed calculateRealizedPnL for -0 edge case
- `packages/shared/src/index.ts` - Fixed import extensions for test compatibility
- `apps/api/prisma/schema.prisma` - Added EquitySnapshot model with user relationship
- `apps/api/src/routes/trades.ts` - Added POST /:tradeId/close endpoint with transaction handling
- `apps/api/src/app.ts` - Fixed import extensions and conditional server startup for tests
- `apps/api/src/routes/users.ts` - Fixed import extension
- `apps/api/tests/setup.ts` - Added NODE_ENV=development for test environment
- `apps/api/tests/unit/calculations.test.ts` - Added comprehensive P/L calculation tests
- `apps/api/tests/integration/routes/trades.test.ts` - Added 12 close trade integration tests

**Frontend Files Created/Modified:**
- `apps/web/src/lib/api.ts` - Added closeTrade API function
- `apps/web/src/components/CloseTradeModal.tsx` - New modal component for trade closing
- `apps/web/src/components/TradeList.tsx` - Added close button, P/L display, modal integration
- `apps/web/tests/unit/components/CloseTradeModal.test.tsx` - Comprehensive component tests
- `apps/web/tests/e2e/close-trade-workflow.spec.ts` - End-to-end workflow tests

## QA Results

### Review Date: August 26, 2025

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation demonstrates excellent architectural decisions and follows financial trading system best practices. The code is well-structured, uses appropriate design patterns, and maintains high standards for monetary calculations using Decimal.js. The separation of concerns between frontend and backend is clear, with proper validation at all layers.

Key strengths:
- Atomic database transactions ensure data consistency
- Proper use of Decimal.js for financial precision
- Comprehensive error handling with specific business logic validation
- Well-structured React components with proper state management
- Real-time P/L preview calculations provide excellent UX

### Refactoring Performed

- **File**: `/Users/sorawutvongpanich/Documents/TradingLog/apps/api/src/routes/trades.ts`
  - **Change**: Added `formatTradeResponse` helper function to eliminate code duplication
  - **Why**: DRY principle violation with repeated trade formatting logic across endpoints
  - **How**: Centralized formatting logic reduces maintenance burden and ensures consistency

- **File**: `/Users/sorawutvongpanich/Documents/TradingLog/apps/api/src/routes/trades.ts`
  - **Change**: Added additional exit price validation for business logic
  - **Why**: Enhanced input validation beyond schema validation for better error messages
  - **How**: Explicit check for positive exit price with descriptive error response

- **File**: `/Users/sorawutvongpanich/Documents/TradingLog/apps/web/src/components/CloseTradeModal.tsx`
  - **Change**: Enhanced accessibility with proper ARIA attributes
  - **Why**: Improved screen reader support and accessibility compliance
  - **How**: Added `aria-describedby` and `role="alert"` to error messages

- **File**: `/Users/sorawutvongpanich/Documents/TradingLog/apps/api/tests/unit/risk-calculations.test.ts`
  - **Change**: Fixed incorrect test expectations for error conditions
  - **Why**: Tests were expecting success for invalid inputs instead of errors
  - **How**: Updated tests to expect thrown errors for zero/negative position sizes

### Compliance Check

- Coding Standards: ✓ Excellent adherence to TypeScript and React best practices
- Project Structure: ✓ Files organized according to established patterns and locations
- Testing Strategy: ✓ Comprehensive unit, integration, and component tests with good coverage
- All ACs Met: ✓ All acceptance criteria fully implemented and verified

### Improvements Checklist

- [x] Eliminated code duplication in trade response formatting (routes/trades.ts)
- [x] Enhanced input validation for exit price (routes/trades.ts)
- [x] Improved accessibility in CloseTradeModal component
- [x] Fixed test assertions to match actual function behavior
- [ ] Consider adding exit price reasonableness validation (e.g., within 50% of entry price)
- [ ] Add rate limiting for trade operations to prevent rapid-fire closes
- [ ] Consider adding audit log for trade closure events

### Security Review

**Excellent security implementation:**
- All endpoints properly authenticated via `requireAuth` middleware
- Authorization enforced through user-specific trade filtering
- Input validation using Zod schemas prevents injection attacks
- Database transactions prevent race conditions
- No sensitive data exposure in error messages

**No security vulnerabilities identified.**

### Performance Considerations

**Well-optimized implementation:**
- Efficient database queries with proper indexing on `userId` and `status`
- Single atomic transaction for all trade close operations
- React Query provides optimal caching and state management
- Component renders are optimized with proper dependency arrays

**Performance is excellent for expected load patterns.**

### Final Status

✓ **Approved - Ready for Done**

This is a high-quality implementation that demonstrates senior-level understanding of financial systems, proper error handling, and user experience design. The code is production-ready with comprehensive test coverage and follows all established patterns and standards.