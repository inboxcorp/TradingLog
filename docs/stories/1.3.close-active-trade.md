# Story 1.3: Close an Active Trade

## Status
Draft

## Story
**As a** trader,  
**I want** to close an active trade by recording the exit price,  
**so that** the system can calculate my realized profit or loss and update my equity.

## Acceptance Criteria

1. Active trades in the journal list have a "Close" button
2. Clicking "Close" prompts the user to enter the final exit price
3. Upon confirmation, the system calculates the realized P/L for the trade
4. The trade's status is updated to "closed," and the P/L is displayed
5. The user's total equity is correctly updated with the realized P/L

## Tasks / Subtasks

- [ ] Task 1: Implement backend API for trade closing (AC: 3, 4, 5)
  - [ ] Create POST /api/trades/{id}/close endpoint
  - [ ] Add exit price validation and P/L calculation using Decimal.js
  - [ ] Update trade status and user equity in database transaction
  - [ ] Create EquitySnapshot record for historical tracking
  - [ ] Return updated trade with calculated P/L

- [ ] Task 2: Create close trade modal component (AC: 2)
  - [ ] Build CloseTradeModal component with exit price input
  - [ ] Add current market price reference (if available)
  - [ ] Show P/L preview calculation
  - [ ] Add confirmation dialog with trade summary
  - [ ] Handle validation and error states

- [ ] Task 3: Add close functionality to trade list (AC: 1)
  - [ ] Add "Close" button to active trade items
  - [ ] Integrate with CloseTradeModal component
  - [ ] Update trade list after successful close
  - [ ] Show success notification with P/L result

- [ ] Task 4: Update equity display and tracking (AC: 5)
  - [ ] Refresh user equity display after trade close
  - [ ] Update total equity in user context/store
  - [ ] Create equity snapshot for historical curve
  - [ ] Ensure real-time UI updates

- [ ] Task 5: Write comprehensive tests (AC: 1, 2, 3, 4, 5)
  - [ ] Backend unit tests for P/L calculations with Decimal.js
  - [ ] Backend integration tests for trade closing endpoint
  - [ ] Frontend component tests for CloseTradeModal
  - [ ] E2E test for complete trade closing workflow
  - [ ] Test equity update accuracy and transaction integrity

## Dev Notes

### Previous Story Context
Story 1.2 established trade creation and the Trade model. This story extends that functionality to handle trade lifecycle completion, including P/L calculations and equity updates.

### Data Models
[Source: docs/architecture.md#data-models]

**EquitySnapshot Model (new):**
```typescript
interface EquitySnapshot {
  id: string;
  userId: string;
  totalEquity: number;
  timestamp: Date;
  source: 'TRADE_CLOSE' | 'MANUAL_UPDATE' | 'DAILY_SNAPSHOT';
}
```

**Trade Model Updates:**
- exitPrice: number | null → populated on close
- exitDate: Date | null → set to current timestamp
- realizedPnL: number | null → calculated P/L
- status: 'ACTIVE' → 'CLOSED'

### API Specifications
[Source: docs/architecture.md#api-specification]

**POST /api/trades/{tradeId}/close**
- Closes an active trade with exit price
- Request body: { exitPrice: number }
- Validates trade ownership and active status
- Calculates P/L and updates user equity
- Returns updated trade with P/L data

### P/L Calculation Requirements
[Source: docs/architecture.md#critical-implementation-requirements]

**CRITICAL: P/L Calculation Formula**
```typescript
import Decimal from 'decimal.js';

const calculatePnL = (trade: Trade, exitPrice: number): number => {
  const entryDecimal = new Decimal(trade.entryPrice);
  const exitDecimal = new Decimal(exitPrice);
  const sizeDecimal = new Decimal(trade.positionSize);
  
  if (trade.direction === 'LONG') {
    return exitDecimal.minus(entryDecimal).times(sizeDecimal).toNumber();
  } else {
    return entryDecimal.minus(exitDecimal).times(sizeDecimal).toNumber();
  }
};

const updateUserEquity = async (userId: string, pnl: number): Promise<void> => {
  await prisma.$transaction(async (tx) => {
    const user = await tx.user.findUnique({ where: { id: userId } });
    const newEquity = new Decimal(user.totalEquity).plus(pnl).toNumber();
    
    await tx.user.update({
      where: { id: userId },
      data: { totalEquity: newEquity }
    });
    
    await tx.equitySnapshot.create({
      data: {
        userId,
        totalEquity: newEquity,
        timestamp: new Date(),
        source: 'TRADE_CLOSE'
      }
    });
  });
};
```

### Frontend Component Specifications
[Source: docs/architecture.md#frontend-architecture]

**CloseTradeModal Component:**
```typescript
interface CloseTradeModalProps {
  trade: Trade;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: (updatedTrade: Trade) => void;
}

// Key features:
// - Pre-populated with trade details
// - Exit price input with validation
// - Real-time P/L preview calculation
// - Confirmation step before final submission
// - Error handling for invalid prices
```

**TradeList Component Updates:**
- Add "Close" button for active trades only
- Disable button during close operation
- Update trade display after successful close
- Show P/L in closed trade items

### File Locations
- EquitySnapshot type: `packages/shared/src/types/index.ts`
- Trade close API: `apps/api/src/routes/trades.ts`
- P/L calculations: `packages/shared/src/utils/calculations.ts`
- CloseTradeModal: `apps/web/src/components/CloseTradeModal.tsx`
- Updated TradeList: `apps/web/src/components/TradeList.tsx`

### Database Transaction Requirements
[Source: docs/architecture.md#critical-implementation-requirements]

**CRITICAL: Atomic Operations**
All trade closing operations must be wrapped in database transactions to ensure:
- Trade status update
- User equity update  
- Equity snapshot creation
- Consistency in case of failures

### Testing

#### Testing Requirements
[Source: docs/architecture.md#testing-strategy]

**Critical Test Scenarios:**
- P/L calculation precision for LONG and SHORT trades
- Decimal precision with various price points
- Concurrent trade closing prevention
- Database transaction rollback on failures
- Exit price validation (reasonable vs. market price)

**Edge Cases:**
- Closing trade with exit price equal to entry price (zero P/L)
- Very large P/L amounts and equity updates
- Network failures during close operation
- Invalid exit prices (negative, unrealistic values)

#### Testing Standards
- Test P/L calculations with known values
- Verify database transaction integrity
- Mock trade close API in frontend tests
- E2E test covers complete close workflow
- Test equity update accuracy

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 15, 2025 | 1.0 | Initial story creation | Sarah, Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_